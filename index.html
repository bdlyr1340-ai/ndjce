<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="theme-color" content="#0b1220" />
  <title>CD PRO - إدارة الاشتراكات</title>

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#0b1220;
      --muted:#6b7280;
      --line:#e5e7eb;

      --primary:#0b1220;
      --accent:#2563eb;

      --success:#16a34a;
      --danger:#ef4444;
      --warning:#f59e0b;

      --radius:18px;
      --shadow: 0 10px 30px rgba(2,6,23,.08);
      --shadow2: 0 2px 10px rgba(2,6,23,.06);
    }

    /* Dark theme */
    html[data-theme="dark"]{
      --bg:#070b14;
      --card:#0b1220;
      --ink:#e5e7eb;
      --muted:#9ca3af;
      --line:rgba(226,232,240,.12);
      --shadow: 0 16px 34px rgba(0,0,0,.35);
      --shadow2: 0 8px 20px rgba(0,0,0,.30);
    }

    *{ box-sizing:border-box; font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,Arial; -webkit-tap-highlight-color:transparent; }
    body{
      margin:0;
      color:var(--ink);
      background:var(--bg);
      padding-bottom:84px; /* bottom nav space */
    }

    /* App bar */
    .appbar{
      position:sticky;
      top:0;
      z-index:50;
      background: linear-gradient(135deg, #0b1220, #020617);
      color:#fff;
      padding:14px 14px 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
    }
    .appbar .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .avatar{
      width:40px;height:40px;
      border-radius:14px;
      display:grid;
      place-items:center;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      font-weight:900;
      letter-spacing:.6px;
      flex:0 0 auto;
      overflow:hidden;
    }
    .avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
      border-radius:13px;
      display:block;
    }
    .brand .txt{
      min-width:0;
    }
    .brand h1{
      margin:0;
      font-size:1.02rem;
      font-weight:900;
      line-height:1.1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand p{
      margin:3px 0 0;
      font-size:.78rem;
      opacity:.86;
      font-weight:700;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .actions{ display:flex; gap:8px; flex:0 0 auto; }
    .icon-btn{
      border:none;
      width:42px;height:42px;
      border-radius:14px;
      display:grid;
      place-items:center;
      cursor:pointer;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      transition: transform .12s ease, background .12s ease;
    }
    .icon-btn:active{ transform: scale(.98); }
    .icon-btn svg{ width:20px; height:20px; fill:none; stroke:#fff; stroke-width:2; stroke-linecap:round; stroke-linejoin:round; }

    /* Layout */
    .container{ padding: 14px; max-width: 760px; margin: 0 auto; }

    /* Cards */
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      padding:14px;
      margin-bottom:12px;
    }
    .card-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .card-title h2{
      margin:0;
      font-size:.95rem;
      font-weight:900;
      letter-spacing:.1px;
    }
    .muted{ color:var(--muted); font-weight:700; font-size:.82rem; }

    .grid{ display:grid; gap:10px; }
    .grid.cols-2{ grid-template-columns: repeat(2, 1fr); }

    .stat{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: 16px;
      padding:12px;
    }
    .stat b{
      display:block;
      font-weight:900;
      font-size:1.1rem;
    }
    .stat span{
      display:block;
      margin-top:4px;
      color:var(--muted);
      font-size:.72rem;
      font-weight:800;
    }

    /* Inputs */
    label{ display:block; font-size:.78rem; font-weight:900; margin-bottom:6px; }
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border:1px solid var(--line);
      border-radius: 14px;
      background: var(--card);
      color: var(--ink);
      outline:none;
      font-size:.92rem;
      font-weight:700;
    }
    textarea{ min-height: 96px; resize:none; }
    .row2{ display:flex; gap:10px; }
    .row2 > div{ flex:1; }

    /* Buttons */
    .btn{
      border:none;
      border-radius: 16px;
      padding:12px 12px;
      font-weight:900;
      font-size:.9rem;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition: transform .12s ease, opacity .12s ease;
    }
    .btn:active{ transform: scale(.99); opacity:.95; }
    .btn.primary{ background: var(--accent); color:#fff; }
    .btn.soft{ background: var(--card); color: var(--ink); border:1px solid var(--line); }
    .btn.danger{ background: var(--danger); color:#fff; }
    .btn.success{ background: var(--success); color:#fff; }
    .btn.full{ width:100%; }

    .btn svg{ width:18px; height:18px; fill:none; stroke:currentColor; stroke-width:2; stroke-linecap:round; stroke-linejoin:round; }

    /* Search bar */
    .search{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .search .in{
      position:relative;
      flex:1;
    }
    .search .in svg{
      position:absolute;
      top:50%;
      transform: translateY(-50%);
      right:12px;
      width:18px;height:18px;
      stroke: var(--muted);
      fill:none;
      stroke-width:2;
      pointer-events:none;
    }
    .search input{
      padding-right: 40px;
    }

    /* Chips */
    .chips{ display:flex; gap:8px; overflow:auto; padding-bottom:6px; }
    .chip{
      border:1px solid var(--line);
      background: var(--card);
      color: var(--ink);
      padding:8px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:.78rem;
      cursor:pointer;
      white-space:nowrap;
    }
    .chip.active{
      border-color: rgba(37,99,235,.35);
      background: rgba(37,99,235,.10);
      color: var(--accent);
    }

    /* Subscriber card */
    .sub{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:14px;
      margin-bottom:10px;
      box-shadow: var(--shadow2);
      position:relative;
      overflow:hidden;
      transition: transform .12s ease;
    }
    .sub:active{ transform: scale(.995); }

    .sub::before{
      content:"";
      position:absolute;
      inset:0;
      border-right: 4px solid var(--accent);
      pointer-events:none;
    }
    .sub.expired::before{ border-right-color: var(--danger); }
    .sub.soon::before{ border-right-color: var(--warning); }
    .sub.vip::before{ border-right-color: #8b5cf6; }

    .sub-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .sub-name{
      font-weight:900;
      font-size: 1rem;
      line-height:1.25;
      margin:0;
    }
    .sub-meta{ margin-top:8px; }
    .sub-meta div{ margin-top:4px; color:var(--muted); font-weight:800; font-size:.82rem; }

    .badge{
      display:inline-flex;
      align-items:center;
      padding:4px 10px;
      border-radius: 999px;
      font-weight:900;
      font-size:.72rem;
      border:1px solid var(--line);
      color: var(--ink);
      background: rgba(148,163,184,.12);
      margin-inline-start:6px;
      white-space:nowrap;
    }
    .badge.good{ background: rgba(22,163,74,.12); border-color: rgba(22,163,74,.20); color: #15803d; }
    .badge.bad{ background: rgba(239,68,68,.12); border-color: rgba(239,68,68,.20); color: #b91c1c; }
    .badge.warn{ background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.22); color: #b45309; }
    .badge.purple{ background: rgba(139,92,246,.12); border-color: rgba(139,92,246,.22); color:#6d28d9; }
    html[data-theme="dark"] .badge.good{ color:#4ade80; }
    html[data-theme="dark"] .badge.bad{ color:#f87171; }
    html[data-theme="dark"] .badge.warn{ color:#fbbf24; }
    html[data-theme="dark"] .badge.purple{ color:#c4b5fd; }

    .sub-actions{
      display:flex;
      gap:10px;
      justify-content:flex-start;
      margin-top:12px;
      padding-top:12px;
      border-top:1px solid var(--line);
    }
    .a-btn{
      width:44px;height:40px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: var(--card);
      cursor:pointer;
      display:grid;
      place-items:center;
    }
    .a-btn svg{ width:18px; height:18px; fill:none; stroke: var(--ink); stroke-width:2; stroke-linecap:round; stroke-linejoin:round; }
    .a-btn.primary{ background: rgba(37,99,235,.10); border-color: rgba(37,99,235,.25); }
    .a-btn.primary svg{ stroke: var(--accent); }
    .a-btn.success{ background: rgba(22,163,74,.10); border-color: rgba(22,163,74,.22); }
    .a-btn.success svg{ stroke: var(--success); }
    .a-btn.danger{ background: rgba(239,68,68,.10); border-color: rgba(239,68,68,.22); }
    .a-btn.danger svg{ stroke: var(--danger); }

    /* Views */
    .view{ display:none; }
    .view.active{ display:block; animation: fade .18s ease; }
    @keyframes fade{ from{ opacity:.2; transform: translateY(6px); } to{ opacity:1; transform:none; } }

    /* Bottom nav */
    .bottom{
      position:fixed;
      bottom:0; left:0; right:0;
      background: var(--card);
      border-top: 1px solid var(--line);
      z-index:60;
      padding: 8px 10px calc(10px + env(safe-area-inset-bottom));
      box-shadow: 0 -14px 30px rgba(2,6,23,.10);
    }
    .nav{
      max-width: 760px;
      margin:0 auto;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:8px;
    }
    .nav button{
      border:none;
      background: transparent;
      padding:10px 8px;
      border-radius: 16px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      cursor:pointer;
      color: var(--muted);
      font-weight:900;
      font-size:.74rem;
    }
    .nav button.active{
      background: rgba(37,99,235,.10);
      color: var(--accent);
    }
    .nav svg{ width:22px; height:22px; fill:none; stroke: currentColor; stroke-width:2; stroke-linecap:round; stroke-linejoin:round; }

    /* Modal */
    .modal{
      position:fixed;
      inset:0;
      background: rgba(2,6,23,.45);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:120;
      padding: 12px;
    }
    .sheet{
      width:100%;
      max-width: 760px;
      background: var(--card);
      border:1px solid var(--line);
      border-bottom:none;
      border-radius: 22px 22px 0 0;
      box-shadow: 0 -18px 36px rgba(0,0,0,.22);
      padding: 14px;
      max-height: 86vh;
      overflow:auto;
    }
    .sheet h3{ margin: 6px 0 6px; font-size: 1rem; font-weight: 900; }
    .sheet .subtxt{ margin:0 0 12px; color: var(--muted); font-weight:800; font-size:.82rem; line-height:1.55; }

    /* Toast */
    .toast{
      position: fixed;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      width: calc(100% - 24px);
      max-width: 760px;
      background: rgba(2,6,23,.92);
      color: #fff;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      padding: 12px 12px;
      box-shadow: 0 18px 44px rgba(0,0,0,.30);
      display:none;
      z-index: 200;
      backdrop-filter: blur(6px);
    }
    .toast .t1{ font-weight:900; margin-bottom:4px; }
    .toast .t2{ font-weight:700; opacity:.95; line-height:1.55; }
    .toast .trow{ margin-top:10px; display:flex; gap:10px; }
    .toast .tbtn{
      border:none;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.14);
      color:#fff;
      border-radius: 14px;
      padding: 10px 12px;
      font-weight:900;
      cursor:pointer;
    }

    /* Receipt hidden */
    #hidden-area{ position: fixed; left: -9999px; top:0; }

    /* ===== Receipt v2 ===== */
    .receipt{
      width: 360px;
      padding: 0;
      border-radius: 20px;
      overflow: hidden;
      background:#fff;
      border: 1px solid #e5e7eb;
      text-align: right;
      direction: rtl;
      position: relative;
    }
    .receipt .r-top{
      padding: 14px 14px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      color:#fff;
      background: linear-gradient(135deg, #0b1220, #020617);
    }
    .receipt.paid .r-top{
      background: linear-gradient(135deg, #16a34a, #065f46);
    }
    .receipt.unpaid .r-top{
      background: linear-gradient(135deg, #ef4444, #7f1d1d);
    }
    .receipt .r-logo{
      width:52px;
      height:52px;
      border-radius: 18px;
      display:grid;
      place-items:center;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.18);
      font-weight: 900;
      overflow:hidden;
      flex: 0 0 auto;
    }
    .receipt .r-logo img{ width:100%; height:100%; object-fit:cover; display:block; }
    .receipt .r-mid{ flex:1; min-width:0; }
    .receipt .r-store{
      font-weight: 900;
      font-size: 1.05rem;
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align:right;
    }
    .receipt .r-meta{
      margin-top: 6px;
      font-weight: 800;
      font-size: .78rem;
      opacity: .92;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align:right;
    }
    .receipt .r-status{
      flex:0 0 auto;
      border: 1px solid rgba(255,255,255,.24);
      background: rgba(255,255,255,.14);
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 900;
      font-size: .78rem;
      white-space: nowrap;
    }
    .receipt .r-body{ padding: 12px 14px 14px; }
    .receipt .r-kv{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding: 7px 0;
      font-weight: 800;
      font-size: .88rem;
      color:#0b1220;
      border-bottom: 1px dashed rgba(148,163,184,.55);
    }
    .receipt .r-kv:last-child{ border-bottom:none; }
    .receipt .r-kv span{ color:#475569; font-weight: 900; }
    .receipt .r-kv b{ font-weight: 900; text-align:left; }
    .receipt .r-kv.total{ border-bottom:none; margin-top: 6px; }
    .receipt .r-kv.total b{ font-size: 1.05rem; }
    .receipt .r-sep{ height:1px; background:#e5e7eb; margin: 10px 0; }
    .receipt .r-head{
      font-weight: 900;
      font-size: .9rem;
      color:#0b1220;
      margin-bottom: 8px;
      text-align:right;
    }
    .receipt .r-paylist{
      margin: 0;
      padding: 0 18px 0 0;
      font-weight: 800;
      color:#0b1220;
      font-size: .85rem;
    }
    .receipt .r-paylist li{ margin: 6px 0; }
    .receipt .pm{
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .receipt .pm-note{
      margin-top: 4px;
      font-size: .78rem;
      color:#475569;
      font-weight: 800;
    }
    .receipt .sk-icon{
      width: 14px;
      height: 14px;
      object-fit: contain;
      display:inline-block;
      border-radius: 3px;
    }
    .receipt .sk-pill{
      font-size: .72rem;
      font-weight: 900;
      border:1px solid #e5e7eb;
      border-radius: 6px;
      padding: 1px 4px;
      background: #f1f5f9;
    }
    .receipt .r-foot{
      white-space: pre-line;
      font-weight: 900;
      font-size: .74rem;
      color:#334155;
      line-height: 1.55;
      text-align:right;
    }
    .receipt .qr-wrap{ display:flex; justify-content:center; margin-top: 12px; }
    .receipt.paid::after{
      content:"مدفوع";
      position:absolute;
      inset:auto -20px 40px auto;
      transform: rotate(12deg);
      font-size: 46px;
      font-weight: 900;
      color: rgba(22,163,74,.14);
      letter-spacing: 2px;
      pointer-events:none;
    }
    .receipt.unpaid::after{
      content:"غير مدفوع";
      position:absolute;
      inset:auto -26px 40px auto;
      transform: rotate(12deg);
      font-size: 40px;
      font-weight: 900;
      color: rgba(239,68,68,.12);
      letter-spacing: 1px;
      pointer-events:none;
    }
  </style>
</head>

<body>
  <!-- Icons -->
  <svg width="0" height="0" style="position:absolute">
    <defs>
      <symbol id="i-home" viewBox="0 0 24 24">
        <path d="M3 10.5 12 3l9 7.5"></path>
        <path d="M5.5 10.5V21h13V10.5"></path>
      </symbol>
      <symbol id="i-users" viewBox="0 0 24 24">
        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
        <path d="M8.5 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8"></path>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
      </symbol>
      <symbol id="i-plus" viewBox="0 0 24 24">
        <path d="M12 5v14"></path>
        <path d="M5 12h14"></path>
      </symbol>
      <symbol id="i-bolt" viewBox="0 0 24 24">
        <path d="M13 2 3 14h9l-1 8 10-12h-9l1-8z"></path>
      </symbol>
      <symbol id="i-menu" viewBox="0 0 24 24">
        <path d="M4 6h16"></path>
        <path d="M4 12h16"></path>
        <path d="M4 18h16"></path>
      </symbol>
      <symbol id="i-search" viewBox="0 0 24 24">
        <circle cx="11" cy="11" r="7"></circle>
        <path d="M21 21l-4.3-4.3"></path>
      </symbol>
      <symbol id="i-wa" viewBox="0 0 24 24">
        <path d="M20 12a8 8 0 0 1-12.2 6.8L4 20l1.3-3.6A8 8 0 1 1 20 12z"></path>
        <path d="M8.5 9.5c.2-1 .6-1.4 1.1-1.4.3 0 .7.1.9.4l.6 1c.1.2.1.5 0 .7l-.3.6c.3.7 1.2 1.7 2.1 2.1l.6-.3c.2-.1.5-.1.7 0l1 .6c.3.2.4.6.4.9 0 .5-.4.9-1.4 1.1-1 .2-2.9-.6-4.5-2.1-1.5-1.6-2.3-3.5-2.1-4.5z"></path>
      </symbol>
      <symbol id="i-check" viewBox="0 0 24 24">
        <path d="M20 6 9 17l-5-5"></path>
      </symbol>
      <symbol id="i-more" viewBox="0 0 24 24">
        <circle cx="5" cy="12" r="1.7"></circle>
        <circle cx="12" cy="12" r="1.7"></circle>
        <circle cx="19" cy="12" r="1.7"></circle>
      </symbol>
      <symbol id="i-edit" viewBox="0 0 24 24">
        <path d="M12 20h9"></path>
        <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
      </symbol>
      <symbol id="i-trash" viewBox="0 0 24 24">
        <path d="M3 6h18"></path>
        <path d="M8 6V4h8v2"></path>
        <path d="M19 6l-1 14H6L5 6"></path>
      </symbol>
      <symbol id="i-renew" viewBox="0 0 24 24">
        <path d="M21 12a9 9 0 0 1-15 6.4"></path>
        <path d="M3 12a9 9 0 0 1 15-6.4"></path>
        <path d="M3 18v-5h5"></path>
        <path d="M21 6v5h-5"></path>
      </symbol>
      <symbol id="i-receipt" viewBox="0 0 24 24">
        <path d="M6 2h12v20l-2-1-2 1-2-1-2 1-2-1-2 1V2z"></path>
        <path d="M8 6h8"></path>
        <path d="M8 10h8"></path>
        <path d="M8 14h6"></path>
      </symbol>
      <symbol id="i-settings" viewBox="0 0 24 24">
        <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"></path>
        <path d="M19.4 15a7.8 7.8 0 0 0 .1-2l2-1.5-2-3.5-2.4 1a7.9 7.9 0 0 0-1.7-1L15 4h-6l-.4 3a7.9 7.9 0 0 0-1.7 1L4.5 7l-2 3.5 2 1.5a7.8 7.8 0 0 0 .1 2l-2 1.5 2 3.5 2.4-1a7.9 7.9 0 0 0 1.7 1L9 22h6l.4-3a7.9 7.9 0 0 0 1.7-1l2.4 1 2-3.5-2-1.5z"></path>
      </symbol>
    </defs>
  </svg>

  <!-- App bar -->
  <header class="appbar">
    <div class="row">
      <div class="brand">
        <div class="avatar" id="uiLogo">CD</div>
        <div class="txt">
          <h1 id="uiStoreName">CD متجر CD</h1>
          <p id="uiSubline">إدارة اشتراكات بشكل سلس وبسيط</p>
        </div>
      </div>

      <div class="actions">
        <button class="icon-btn" onclick="openQuickSale()" aria-label="بيع سريع">
          <svg><use href="#i-bolt"></use></svg>
        </button>
        <button class="icon-btn" onclick="openMenu()" aria-label="القائمة">
          <svg><use href="#i-menu"></use></svg>
        </button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Home -->
    <section id="view-home" class="view active">
      <div class="card">
        <div class="card-title">
          <h2>لوحة اليوم</h2>
          <span class="muted" id="uiTodayLine">—</span>
        </div>

        <div class="grid cols-2">
          <div class="stat"><b id="stTodayIncome">0</b><span>دخل اليوم</span></div>
          <div class="stat"><b id="stTotalIncome">0</b><span>إجمالي الدخل</span></div>
          <div class="stat"><b id="stActive">0</b><span>مشترك فعّال</span></div>
          <div class="stat"><b id="stExpSoon">0</b><span id="lblExpSoon">قريب الانتهاء</span></div>
        </div>

        <div class="grid cols-2" style="margin-top:10px;">
          <button class="btn primary full" onclick="go('add')">
            <svg><use href="#i-plus"></use></svg>
            إضافة اشتراك
          </button>
          <button class="btn soft full" onclick="openReminders()">
            عرض المنتهي قريباً
          </button>
        </div>
      </div>

      <div class="card">
        <div class="card-title">
          <h2>قائمة قريبة الانتهاء</h2>
          <button class="btn soft" onclick="go('subs')">عرض الكل</button>
        </div>
        <div id="uiSoonList"></div>
      </div>

      <div class="card">
        <div class="card-title">
          <h2>آخر النشاط</h2>
          <button class="btn soft" onclick="clearActivity()">مسح</button>
        </div>
        <div id="uiActivity"></div>
      </div>
    </section>

    <!-- Subscribers -->
    <section id="view-subs" class="view">
      <div class="card">
        <div class="card-title">
          <h2>المشتركين</h2>
          <span class="muted" id="uiCountLine">0</span>
        </div>

        <div class="search" style="margin-bottom:10px;">
          <div class="in">
            <svg><use href="#i-search"></use></svg>
            <input id="qSub" type="text" placeholder="بحث بالاسم أو الرقم أو الخدمة" oninput="renderSubs()" />
          </div>
          <button class="btn soft" onclick="renderSubs()">بحث</button>
        </div>

        <div class="chips">
          <button class="chip active" id="f_all" onclick="setFilter('all')">الكل</button>
          <button class="chip" id="f_active" onclick="setFilter('active')">فعّال</button>
          <button class="chip" id="f_soon" onclick="setFilter('soon')">قريب الانتهاء</button>
          <button class="chip" id="f_expired" onclick="setFilter('expired')">منتهي</button>
          <button class="chip" id="f_unpaid" onclick="setFilter('unpaid')">غير مدفوع</button>
          <button class="chip" id="f_paid" onclick="setFilter('paid')">مدفوع</button>
          <button class="chip" id="f_vip" onclick="setFilter('vip')">VIP</button>
        </div>
      </div>

      <div id="uiSubs"></div>
    </section>

    <!-- Add -->
    <section id="view-add" class="view">
      <div class="card">
        <div class="card-title">
          <h2>إضافة اشتراك</h2>
          <span class="muted">سريع ومرتب</span>
        </div>

        <div class="row2">
          <div>
            <label>الخدمة</label>
            <select id="fService" onchange="applyServiceDefaults()"></select>
          </div>
          <div>
            <label>المدة</label>
            <select id="fDuration" onchange="calcEnd(); applyServiceDefaults();">
              <option value="1">شهر</option>
              <option value="3">3 أشهر</option>
              <option value="12">سنة</option>
            </select>
          </div>
        </div>

        <div style="margin-top:10px;">
          <label>اسم الزبون</label>
          <input id="fName" placeholder="الاسم" />
        </div>

        <div style="margin-top:10px;">
          <label>رقم الواتساب</label>
          <input id="fPhone" placeholder="07xxxxxxxxx" />
        </div>

        <div class="row2" style="margin-top:10px;">
          <div>
            <label>المبلغ (دينار)</label>
            <input id="fPrice" type="number" value="15000" />
          </div>
          <div>
            <label>VIP</label>
            <select id="fVip">
              <option value="no">لا</option>
              <option value="yes">نعم</option>
            </select>
          </div>
        </div>

        <div class="row2" style="margin-top:10px;">
          <div>
            <label>تاريخ البدء</label>
            <input id="fStart" type="date" onchange="calcEnd()" />
          </div>
          <div>
            <label>تاريخ النهاية</label>
            <input id="fEnd" type="date" disabled />
          </div>
        </div>

        <div style="margin-top:10px;">
          <label>ملاحظة (اختياري)</label>
          <textarea id="fNote" placeholder="ملاحظة"></textarea>
        </div>

        <button class="btn primary full" style="margin-top:12px;" onclick="addCustomer()">
          حفظ الاشتراك
        </button>
      </div>
    </section>
  </main>

  <!-- Bottom nav -->
  <nav class="bottom" aria-label="التنقل">
    <div class="nav">
      <button id="nav-home" class="active" onclick="go('home')">
        <svg><use href="#i-home"></use></svg>
        الرئيسية
      </button>
      <button id="nav-subs" onclick="go('subs')">
        <svg><use href="#i-users"></use></svg>
        المشتركين
      </button>
      <button id="nav-add" onclick="go('add')">
        <svg><use href="#i-plus"></use></svg>
        إضافة
      </button>
    </div>
  </nav>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite">
    <div class="t1" id="toastT">—</div>
    <div class="t2" id="toastB">—</div>
    <div class="trow" id="toastActions" style="display:none;"></div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal" onclick="closeModal(event)">
    <div class="sheet" onclick="event.stopPropagation()">
      <div id="modalBody"></div>
    </div>
  </div>

  <!-- Receipt Hidden -->
  <div id="hidden-area">
    <div id="receiptBox" class="receipt unpaid">
      <div class="r-top">
        <div class="r-logo" id="rLogo">CD</div>
        <div class="r-mid">
          <div class="r-store" id="rStore">CD متجر CD</div>
          <div class="r-meta" id="rMeta">وصل</div>
        </div>
        <div class="r-status" id="rStatusBadge">—</div>
      </div>

      <div class="r-body">
        <div id="rData"></div>

        <div class="r-sep"></div>

        <div class="r-head" id="rPayTitle">طرق الدفع</div>
        <ul id="rPayList" class="r-paylist"></ul>

        <div class="r-sep"></div>

        <div class="r-foot" id="rFoot"></div>
        <div class="qr-wrap"><div id="rQR"></div></div>
      </div>
    </div>
  </div>

  <script>
    // =============================
    // KODULAR BRIDGE (فتح روابط خارج WebViewer)
    // =============================
    function openExternal(url){
      try{
        if(window.Kodular && window.Kodular.setWebViewString){
          window.Kodular.setWebViewString("OPEN_URL:" + url);
          return;
        }
        if(window.AppInventor && window.AppInventor.setWebViewString){
          window.AppInventor.setWebViewString("OPEN_URL:" + url);
          return;
        }
      }catch(e){}
      // fallback (browser)
      window.location.href = url;
    }

    // =============================
    // Polyfills / Helpers
    // =============================
    function cloneObj(o){
      try{
        if(typeof structuredClone === "function") return structuredClone(o);
      }catch(e){}
      return JSON.parse(JSON.stringify(o));
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }

    // =============================
    // SETTINGS (yours)
    // =============================
    const DEFAULT_SETTINGS = {
      storeName: "CD متجر CD",
      whatsappOwner: "07728257333",
      instagramUrl: "https://www.instagram.com/8j_37?igsh=ZDl2Ym91dmt1OGgy",

      // ✅ جديد
      logoDataUrl: "",
      superKeyIconDataUrl: "",

      theme: "system",
      accent: "#2563eb",
      remindDaysBefore: 1,

      paymentMethods: [
        "ماستر سوبر كي",
        "اساسيل",
        "فاينص USDT (عملة رقمية)"
      ],

      waTemplates: {
        reminder:
`*{store}*
السلام عليكم {name}
تنبيه: اشتراك {service} سينتهي بتاريخ {end}.
المتبقي: {daysLeftHuman}

هل ترغب بالتجديد؟
رد بكلمة: نعم`,
        status:
`*{store}*
مرحباً {name}
الخدمة: {service}
الانتهاء: {end}
المتبقي: {daysLeftHuman}
الحالة: {paidStatus}`,
        thanks:
`*{store}*
شكراً {name}
تم استلام الدفع بنجاح
الخدمة: {service}
الانتهاء: {end}`
      },

      services: [
        { name:"ChatGPT Plus", prices:{ "1":15000, "3":45000, "12":180000 } },
        { name:"ChatGPT Pro",  prices:{ "1":15000, "3":45000, "12":180000 } },
        { name:"Gemini",       prices:{ "1":15000, "3":45000, "12":180000 } },

        { name:"Canva Pro",    prices:{ "1":15000, "3":45000, "12":180000 } },
        { name:"CapCut Pro",   prices:{ "1":15000, "3":45000, "12":180000 } },
        { name:"YouTube",      prices:{ "1":15000, "3":45000, "12":180000 } }
      ]
    };

    const K_SETTINGS  = "cd_pro_settings_v3";
    const K_CUSTOMERS = "cd_pro_customers_v3";
    const K_SALES     = "cd_pro_sales_v3";
    const K_ACTIVITY  = "cd_pro_activity_v3";
    const K_SCHEMA    = "cd_pro_schema_v3";

    const LEGACY = {
      settings: ["cd_pro_settings_v2","cd_pro_settings_v1"],
      customers:["cd_pro_customers_v2","cd_pro_customers_v1"],
      sales:    ["cd_pro_sales_v2","cd_pro_sales_v1"],
      activity: ["cd_pro_activity_v2","cd_pro_activity_v1"]
    };

    function load(key, fallback){
      try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }
      catch(e){ return fallback; }
    }
    function save(key, value){ localStorage.setItem(key, JSON.stringify(value)); }
    function deepMerge(target, src){
      if(!src || typeof src !== "object") return target;
      for(const k of Object.keys(src)){
        const v = src[k];
        if(v && typeof v === "object" && !Array.isArray(v)){
          if(!target[k] || typeof target[k] !== "object" || Array.isArray(target[k])) target[k] = {};
          deepMerge(target[k], v);
        }else target[k] = v;
      }
      return target;
    }
    function uid(){
      try{
        if(window.crypto && window.crypto.randomUUID) return window.crypto.randomUUID();
      }catch(e){}
      return (Date.now()+"_"+Math.random().toString(16).slice(2));
    }
    function nowISO(){ return new Date().toISOString(); }
    function ymd(d=new Date()){
      const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      const m = String(x.getMonth()+1).padStart(2,"0");
      const day = String(x.getDate()).padStart(2,"0");
      return `${x.getFullYear()}-${m}-${day}`;
    }
    function parseYMD(s){
      if(!s) return null;
      const p = s.split("-");
      if(p.length!==3) return null;
      return new Date(Number(p[0]), Number(p[1])-1, Number(p[2]));
    }
    function daysLeft(endYmd){
      const end = parseYMD(endYmd);
      if(!end) return null;
      const today = parseYMD(ymd());
      const ms = end.getTime() - today.getTime();
      return Math.round(ms / 86400000);
    }
    function daysLeftHuman(dl){
      if(dl === null || dl === undefined) return "—";
      if(dl < 0) return `منتهي منذ ${Math.abs(dl)} يوم`;
      if(dl === 0) return "اليوم";
      if(dl === 1) return "غداً";
      return `${dl} أيام`;
    }
    function money(n){
      const x = Number(n||0);
      return x.toLocaleString("ar-IQ") + " د.ع";
    }
    function cleanPhone(p){ return String(p||"").replace(/\s+/g,"").trim(); }
    function toWA(phone){
      let p = cleanPhone(phone);
      if(p.startsWith("07")) p = "964" + p.substring(1);
      return p;
    }
    function formatTemplate(tpl, data){
      const s = String(tpl||"");
      return s.replace(/\{(\w+)\}/g, (_,k)=> (data[k]!==undefined && data[k]!==null) ? String(data[k]) : "");
    }
    function getRemindDays(){
      const x = Number(settings.remindDaysBefore);
      if(Number.isFinite(x)) return Math.max(0, Math.min(14, Math.floor(x)));
      return 1;
    }
    function timeHM(ts){
      try{
        return new Date(ts).toLocaleTimeString("ar-IQ", { hour:"2-digit", minute:"2-digit" });
      }catch(e){ return ""; }
    }

    let settings = deepMerge(cloneObj(DEFAULT_SETTINGS), load(K_SETTINGS, {}));
    let customers = load(K_CUSTOMERS, []);
    let sales = load(K_SALES, []);
    let activity = load(K_ACTIVITY, []);

    let filter = "all";
    let lastDeleted = null;

    (function migrate(){
      const done = load(K_SCHEMA, null);
      if(done === "ok") return;

      if(!localStorage.getItem(K_SETTINGS)){
        for(const k of LEGACY.settings){
          const v = load(k, null);
          if(v && typeof v === "object"){
            settings = deepMerge(cloneObj(DEFAULT_SETTINGS), v);
            save(K_SETTINGS, settings);
            break;
          }
        }
      }
      if(customers.length===0){
        for(const k of LEGACY.customers){
          const v = load(k, null);
          if(Array.isArray(v) && v.length){
            customers = v; save(K_CUSTOMERS, customers); break;
          }
        }
      }
      if(sales.length===0){
        for(const k of LEGACY.sales){
          const v = load(k, null);
          if(Array.isArray(v) && v.length){
            sales = v; save(K_SALES, sales); break;
          }
        }
      }
      if(activity.length===0){
        for(const k of LEGACY.activity){
          const v = load(k, null);
          if(Array.isArray(v) && v.length){
            activity = v; save(K_ACTIVITY, activity); break;
          }
        }
      }
      save(K_SCHEMA, "ok");
    })();

    function applyTheme(){
      document.documentElement.style.setProperty("--accent", settings.accent || DEFAULT_SETTINGS.accent);
      let t = String(settings.theme || "system");
      if(!["system","light","dark"].includes(t)) t = "system";
      let finalTheme = t;
      if(t==="system"){
        finalTheme = (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) ? "dark" : "light";
      }
      document.documentElement.setAttribute("data-theme", finalTheme);
    }

    function logoText(){
      const s = String(settings?.storeName || "").trim();
      const latin = (s.match(/[A-Za-z0-9]/g) || []).join("");
      if(latin.length >= 2) return latin.slice(0,2).toUpperCase();
      if(s.length >= 2) return s.slice(0,2);
      return "CD";
    }

    function setLogoInto(el){
      if(!el) return;
      el.innerHTML = "";
      if(settings.logoDataUrl){
        const img = document.createElement("img");
        img.src = settings.logoDataUrl;
        img.alt = "logo";
        el.appendChild(img);
      }else{
        el.textContent = logoText();
      }
    }

    function applyBrand(){
      const t = settings.storeName || DEFAULT_SETTINGS.storeName;
      const nameEl = document.getElementById("uiStoreName");
      if(nameEl) nameEl.textContent = t;

      const logoEl = document.getElementById("uiLogo");
      if(logoEl) setLogoInto(logoEl);
    }

    function sumIncomeAll(){
      const paidSum = customers.reduce((s,c)=> s + (c.paid ? Number(c.price||0) : 0), 0);
      const salesSum = sales.reduce((s,x)=> s + Number(x.amount||0), 0);
      return paidSum + salesSum;
    }
    function sumIncomeToday(){
      const todayKey = ymd();
      const paidToday = customers.reduce((s,c)=>{
        if(!c.paid || !c.paidAt) return s;
        const k = ymd(new Date(c.paidAt));
        return s + (k===todayKey ? Number(c.price||0) : 0);
      }, 0);
      const salesToday = sales.reduce((s,x)=> (ymd(new Date(x.ts))===todayKey ? s + Number(x.amount||0) : s), 0);
      return paidToday + salesToday;
    }
    function countActive(){
      return customers.filter(c=>{
        const dl = daysLeft(c.end);
        return dl !== null && dl >= 0;
      }).length;
    }
    function countSoon(){
      const d = getRemindDays();
      return customers.filter(c=>{
        const dl = daysLeft(c.end);
        return dl !== null && dl >= 0 && dl <= d;
      }).length;
    }

    function go(view){
      const views = ["home","subs","add"];
      views.forEach(v=>{
        document.getElementById("view-"+v).classList.toggle("active", v===view);
        document.getElementById("nav-"+v).classList.toggle("active", v===view);
      });
      if(view==="home") renderHome();
      if(view==="subs") renderSubs();
      if(view==="add") renderAddInit();
      window.scrollTo({ top:0, behavior:"smooth" });
    }

    function normalizeServices(){
      if(!Array.isArray(settings.services) || settings.services.length===0){
        settings.services = cloneObj(DEFAULT_SETTINGS.services);
      }
    }
    function renderServicesSelect(){
      normalizeServices();
      const sel = document.getElementById("fService");
      if(!sel) return;
      const prev = sel.value;
      sel.innerHTML = "";
      settings.services.forEach(s=>{
        const opt = document.createElement("option");
        opt.value = s.name;
        opt.textContent = s.name;
        sel.appendChild(opt);
      });
      if(prev && Array.from(sel.options).some(o=>o.value===prev)) sel.value = prev;
    }
    function serviceByName(name){
      normalizeServices();
      return settings.services.find(s=> String(s.name)===String(name));
    }
    function getServicePrice(serviceName, months){
      const svc = serviceByName(serviceName);
      if(!svc) return null;
      const m = String(months||1);
      if(svc.prices && svc.prices[m] !== undefined) return Number(svc.prices[m]||0);
      return null;
    }
    function applyServiceDefaults(){
      const svcName = document.getElementById("fService").value;
      const dm = Number(document.getElementById("fDuration").value||1);
      const price = getServicePrice(svcName, dm);
      const f = document.getElementById("fPrice");
      if(price !== null && Number.isFinite(price)){
        if(!f.value || Number(f.value)<=0 || f.dataset.auto==="1"){
          f.value = price;
          f.dataset.auto = "1";
        }
      }
    }

    function calcEnd(){
      const start = parseYMD(document.getElementById("fStart").value);
      const dm = Number(document.getElementById("fDuration").value||1);
      if(!start) return;
      const end = new Date(start.getFullYear(), start.getMonth()+dm, start.getDate());
      document.getElementById("fEnd").value = ymd(end);
    }

    function renderAddInit(){
      renderServicesSelect();
      const startEl = document.getElementById("fStart");
      if(startEl && !startEl.value) startEl.value = ymd();
      calcEnd();
      const priceEl = document.getElementById("fPrice");
      if(priceEl && !priceEl.dataset.auto) priceEl.dataset.auto = "1";
      applyServiceDefaults();
    }

    function addCustomer(){
      const name = (document.getElementById("fName").value||"").trim();
      const phone = (document.getElementById("fPhone").value||"").trim();
      if(!name || !phone) return alert("اكتب الاسم والرقم أولاً");

      const service = document.getElementById("fService").value || "خدمة";
      const dm = Number(document.getElementById("fDuration").value||1);
      const start = document.getElementById("fStart").value || ymd();
      const end = document.getElementById("fEnd").value || ymd();
      const price = Number(document.getElementById("fPrice").value||0);

      const c = {
        id: uid(),
        name, phone, service,
        durationMonths: dm,
        start, end, price,
        paid: false, paidAt: null,
        paidMethod: null,
        paidNote: "",
        remindedEnd: null,
        vip: (document.getElementById("fVip").value === "yes"),
        note: (document.getElementById("fNote").value||"").trim(),
        createdAt: nowISO()
      };

      customers.unshift(c);
      save(K_CUSTOMERS, customers);

      addActivity("add", `تمت إضافة اشتراك: ${name}`, price);

      document.getElementById("fName").value="";
      document.getElementById("fPhone").value="";
      document.getElementById("fNote").value="";
      document.getElementById("fVip").value="no";
      document.getElementById("fPrice").dataset.auto="1";
      applyServiceDefaults();

      showToast("تم الحفظ", "تمت إضافة الاشتراك بنجاح");
      go("subs");
    }

    function addActivity(type, text, amount=null){
      activity.unshift({ id: uid(), ts: nowISO(), type, text, amount });
      activity = activity.slice(0, 80);
      save(K_ACTIVITY, activity);
    }
    function clearActivity(){
      if(!confirm("مسح سجل النشاط؟")) return;
      activity = [];
      save(K_ACTIVITY, activity);
      renderHome();
      showToast("تم", "تم مسح سجل النشاط");
    }

    function statusOf(c){
      const dl = daysLeft(c.end);
      const expired = (dl !== null && dl < 0);
      const soon = (dl !== null && dl >= 0 && dl <= getRemindDays());
      return { dl, expired, soon };
    }

    function setFilter(f){
      filter = f;
      ["all","active","soon","expired","unpaid","paid","vip"].forEach(x=>{
        document.getElementById("f_"+x).classList.toggle("active", x===f);
      });
      renderSubs();
    }

    // =============================
    // Modal / Toast
    // =============================
    function showModal(html){
      const m = document.getElementById("modal");
      const b = document.getElementById("modalBody");
      b.innerHTML = html;
      m.style.display = "flex";
    }
    function hideModal(){
      const m = document.getElementById("modal");
      m.style.display = "none";
      document.getElementById("modalBody").innerHTML = "";
    }
    function closeModal(ev){
      if(ev && ev.target && ev.target.id === "modal") hideModal();
    }

    let toastTimer = null;
    function showToast(title, body, actions=null, timeout=3000){
      const el = document.getElementById("toast");
      const t = document.getElementById("toastT");
      const b = document.getElementById("toastB");
      const arow = document.getElementById("toastActions");

      t.textContent = title || "—";
      b.textContent = body || "—";

      arow.innerHTML = "";
      if(actions && actions.length){
        arow.style.display = "flex";
        actions.forEach(x=>{
          const btn = document.createElement("button");
          btn.className = "tbtn";
          btn.textContent = x.label || "زر";
          btn.onclick = ()=>{ try{ if(x.action) x.action(); }catch(e){} };
          arow.appendChild(btn);
        });
      }else{
        arow.style.display = "none";
      }

      el.style.display = "block";
      clearTimeout(toastTimer);
      if(timeout && timeout > 0){
        toastTimer = setTimeout(hideToast, timeout);
      }
    }
    function hideToast(){
      const el = document.getElementById("toast");
      el.style.display = "none";
      document.getElementById("toastActions").style.display = "none";
      document.getElementById("toastActions").innerHTML = "";
    }

    // =============================
    // WhatsApp
    // =============================
    function sendWA(id, mode="auto"){
      const c = customers.find(x=>x.id===id);
      if(!c) return;

      const st = statusOf(c);
      const p = toWA(c.phone);
      if(!p) return alert("رقم غير صحيح");

      const remindDays = getRemindDays();
      if(mode==="auto"){
        if(st.dl !== null && st.dl >= 0 && st.dl <= remindDays) mode="reminder";
        else mode="status";
      }

      const data = {
        store: settings.storeName,
        name: c.name,
        service: c.service,
        end: c.end,
        daysLeftHuman: daysLeftHuman(st.dl),
        paidStatus: c.paid ? "مدفوع" : "غير مدفوع"
      };

      let tpl = settings.waTemplates?.status || DEFAULT_SETTINGS.waTemplates.status;
      if(mode==="reminder") tpl = settings.waTemplates?.reminder || DEFAULT_SETTINGS.waTemplates.reminder;
      if(mode==="thanks") tpl = settings.waTemplates?.thanks || DEFAULT_SETTINGS.waTemplates.thanks;

      const msg = formatTemplate(tpl, data);

      if(mode==="reminder"){
        c.remindedEnd = c.end;
        save(K_CUSTOMERS, customers);
        addActivity("reminder", `تم إرسال تذكير: ${c.name}`, null);
        renderHome(); renderSubs();
      }

      const url = `https://wa.me/${p}?text=${encodeURIComponent(msg)}`;
      openExternal(url);
    }

    // =============================
    // Payments: choose method + (super key icon in receipt)
    // =============================
    function isSuperKeyMethod(method){
      return /سوبر\s*كي|سوبركي|super\s*key/i.test(String(method||""));
    }
    function superKeyIconHtml(){
      if(settings.superKeyIconDataUrl){
        return ` <img class="sk-icon" src="${settings.superKeyIconDataUrl}" alt="SK">`;
      }
      return ` <span class="sk-pill">SK</span>`;
    }

    function togglePaid(id){
      const i = customers.findIndex(x=>x.id===id);
      if(i<0) return;
      const c = customers[i];

      if(!c.paid){
        openPaidModal(id);
        return;
      }

      c.paid = false;
      c.paidAt = null;
      c.paidMethod = null;
      c.paidNote = "";
      addActivity("unpay", `تم إلغاء الدفع: ${c.name}`, Number(c.price||0));
      save(K_CUSTOMERS, customers);
      showToast("تم", "تم إلغاء الدفع");
      renderHome(); renderSubs();
    }

    function openPaidModal(id){
      const c = customers.find(x=>x.id===id);
      if(!c) return;

      const methods = Array.isArray(settings.paymentMethods) && settings.paymentMethods.length
        ? settings.paymentMethods
        : DEFAULT_SETTINGS.paymentMethods;

      const opts = methods.map(m=>`<option value="${escapeHtml(m)}">${escapeHtml(m)}</option>`).join("");

      const html = `
        <h3>تسجيل الدفع</h3>
        <p class="subtxt">اختر طريقة الدفع لتظهر في الوصل (ويظهر شعار سوبر كي تلقائياً إذا اخترته).</p>

        <label>طريقة الدفع</label>
        <select id="pMethod">${opts}</select>

        <div style="margin-top:10px;">
          <label>ملاحظة (اختياري)</label>
          <input id="pNote" placeholder="مثال: رقم الحوالة أو ملاحظة"/>
        </div>

        <div class="grid cols-2" style="margin-top:12px;">
          <button class="btn success full" onclick="confirmPaid('${id}')">تأكيد</button>
          <button class="btn soft full" onclick="hideModal()">إلغاء</button>
        </div>
      `;
      showModal(html);
    }

    function confirmPaid(id){
      const i = customers.findIndex(x=>x.id===id);
      if(i<0) return;
      const c = customers[i];

      c.paid = true;
      c.paidAt = nowISO();
      c.paidMethod = document.getElementById("pMethod").value || null;
      c.paidNote = (document.getElementById("pNote").value||"").trim();

      addActivity("pay", `تم تسجيل دفع: ${c.name}`, Number(c.price||0));
      save(K_CUSTOMERS, customers);

      hideModal();
      showToast("تم", "تم تسجيل الدفع");
      renderHome(); renderSubs();
    }

    // =============================
    // Renew / Delete / Undo
    // =============================
    function confirmRenew(id){
      const i = customers.findIndex(x=>x.id===id);
      if(i<0) return;
      const c = customers[i];
      const dm = Math.max(1, Number(c.durationMonths||1));

      const start = parseYMD(ymd());
      const end = new Date(start.getFullYear(), start.getMonth()+dm, start.getDate());

      c.start = ymd(start);
      c.end = ymd(end);
      c.paid = false;
      c.paidAt = null;
      c.paidMethod = null;
      c.paidNote = "";
      c.remindedEnd = null;

      save(K_CUSTOMERS, customers);
      addActivity("renew", `تم تجديد الاشتراك: ${c.name}`, null);

      hideModal();
      showToast("تم", "تم تجديد الاشتراك");
      renderHome(); renderSubs();
    }

    function deleteCustomer(id){
      const i = customers.findIndex(x=>x.id===id);
      if(i<0) return;
      if(!confirm("حذف الزبون؟")) return;

      lastDeleted = customers[i];
      customers.splice(i,1);
      save(K_CUSTOMERS, customers);
      addActivity("del", `تم حذف: ${lastDeleted.name}`, null);

      hideModal();
      renderHome(); renderSubs();

      showToast("تم الحذف", "يمكنك التراجع خلال ثواني", [
        { label:"تراجع", action: undoDelete }
      ], 6500);
    }

    function undoDelete(){
      if(!lastDeleted) return;
      customers.unshift(lastDeleted);
      save(K_CUSTOMERS, customers);
      addActivity("undo", `تم التراجع عن الحذف: ${lastDeleted.name}`, null);
      lastDeleted = null;
      hideToast();
      renderHome(); renderSubs();
      showToast("تم", "تم التراجع عن الحذف");
    }

    // =============================
    // Quick sale
    // =============================
    function openQuickSale(){
      const html = `
        <h3>بيع سريع</h3>
        <p class="subtxt">يسجل دخل اليوم بدون إضافة زبون.</p>

        <label>المبلغ (دينار)</label>
        <input id="qsAmount" type="number" value="15000"/>

        <div style="margin-top:10px;">
          <label>ملاحظة (اختياري)</label>
          <input id="qsNote" placeholder="وصف بسيط"/>
        </div>

        <div class="grid cols-2" style="margin-top:12px;">
          <button class="btn primary full" onclick="addQuickSale()">حفظ</button>
          <button class="btn soft full" onclick="hideModal()">إلغاء</button>
        </div>
      `;
      showModal(html);
    }

    function addQuickSale(){
      const amount = Number(document.getElementById("qsAmount").value||0);
      if(amount<=0) return alert("اكتب مبلغ صحيح");

      const note = (document.getElementById("qsNote").value||"").trim();
      const item = { id: uid(), ts: nowISO(), amount, note };
      sales.unshift(item);
      sales = sales.slice(0, 800);
      save(K_SALES, sales);

      addActivity("sale", `بيع سريع${note? ": "+note:""}`, amount);

      hideModal();
      renderHome();
      showToast("تم", "تم تسجيل البيع");
    }

    // =============================
    // Menu / Backup / Reset
    // =============================
    function openMenu(){
      const body = `
        <h3>القائمة</h3>
        <p class="subtxt">إعدادات المتجر والنسخ الاحتياطي.</p>

        <div class="grid cols-2">
          <button class="btn soft full" onclick="openSettings()">
            <svg><use href="#i-settings"></use></svg>
            الإعدادات
          </button>
          <button class="btn soft full" onclick="openBackup()">
            <svg><use href="#i-receipt"></use></svg>
            نسخة احتياطية
          </button>
        </div>

        <div class="grid cols-2" style="margin-top:10px;">
          <button class="btn soft full" onclick="openReminders()">المنتهي قريباً</button>
          <button class="btn soft full" onclick="hideModal()">إغلاق</button>
        </div>
      `;
      showModal(body);
    }

    function openBackup(){
      const pack = { settings, customers, sales, activity, exportedAt: nowISO() };
      const json = JSON.stringify(pack, null, 2);
      window.__backupJSON = json;

      const body = `
        <h3>نسخة احتياطية</h3>
        <p class="subtxt">تصدير أو استيراد ملف JSON. البيانات تبقى على جهازك.</p>

        <div class="grid cols-2">
          <button class="btn primary full" onclick="downloadBackup()">تصدير JSON</button>
          <button class="btn soft full" onclick="copyBackup()">نسخ JSON</button>
        </div>

        <div style="margin-top:12px;">
          <label>استيراد (ملف JSON)</label>
          <input type="file" id="impFile" accept="application/json"/>
        </div>

        <div class="grid cols-2" style="margin-top:12px;">
          <button class="btn success full" onclick="importBackup()">استيراد</button>
          <button class="btn danger full" onclick="resetAll()">تصفير الكل</button>
        </div>

        <div style="margin-top:12px;" class="muted">© ${escapeHtml(settings.storeName)} - جميع الحقوق محفوظة</div>
      `;
      showModal(body);
    }

    function downloadBackup(){
      const blob = new Blob([window.__backupJSON || "{}"], { type:"application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `CD-PRO-backup-${ymd()}.json`;
      a.click();
      setTimeout(()=> URL.revokeObjectURL(a.href), 2000);
    }
    async function copyBackup(){
      try{
        await navigator.clipboard.writeText(window.__backupJSON || "");
        showToast("تم", "تم نسخ النسخة الاحتياطية");
      }catch(e){
        alert("المتصفح لم يسمح بالنسخ. استخدم التصدير.");
      }
    }
    async function importBackup(){
      const f = document.getElementById("impFile").files[0];
      if(!f) return alert("اختر ملف أولاً");
      const txt = await f.text();
      try{
        const pack = JSON.parse(txt);
        if(pack.settings) settings = deepMerge(cloneObj(DEFAULT_SETTINGS), pack.settings);
        if(Array.isArray(pack.customers)) customers = pack.customers;
        if(Array.isArray(pack.sales)) sales = pack.sales;
        if(Array.isArray(pack.activity)) activity = pack.activity;

        save(K_SETTINGS, settings);
        save(K_CUSTOMERS, customers);
        save(K_SALES, sales);
        save(K_ACTIVITY, activity);

        applyTheme();
        applyBrand();
        hideModal();
        showToast("تم", "تم الاستيراد بنجاح");
        renderAll();
      }catch(e){
        alert("ملف غير صالح");
      }
    }
    function resetAll(){
      const ok = prompt("اكتب كلمة (حذف) للتأكيد:");
      if(ok !== "حذف") return;

      localStorage.removeItem(K_SETTINGS);
      localStorage.removeItem(K_CUSTOMERS);
      localStorage.removeItem(K_SALES);
      localStorage.removeItem(K_ACTIVITY);
      localStorage.removeItem(K_SCHEMA);

      settings = cloneObj(DEFAULT_SETTINGS);
      customers = [];
      sales = [];
      activity = [];
      save(K_SCHEMA, "ok");

      applyTheme();
      applyBrand();
      hideModal();
      showToast("تم", "تم تصفير البيانات");
      renderAll();
      go("home");
    }

    function servicesToText(list){
      if(!Array.isArray(list)) return "";
      return list.map(s=>{
        const p1 = (s.prices && s.prices["1"]!==undefined) ? s.prices["1"] : "";
        const p3 = (s.prices && s.prices["3"]!==undefined) ? s.prices["3"] : "";
        const p12= (s.prices && s.prices["12"]!==undefined) ? s.prices["12"] : "";
        return `${s.name||""}|${p1||""}|${p3||""}|${p12||""}`;
      }).join("\n");
    }
    function parseServicesText(txt){
      const lines = String(txt||"").split("\n").map(x=>x.trim()).filter(Boolean);
      const out = [];
      lines.forEach(line=>{
        const parts = line.split("|").map(x=>x.trim());
        const name = parts[0];
        if(!name) return;
        const p1 = Number(parts[1]||0);
        const p3 = Number(parts[2]|| (p1? p1*3 : 0));
        const p12= Number(parts[3]|| (p1? p1*12: 0));
        out.push({ name, prices:{ "1":p1||0, "3":p3||0, "12":p12||0 } });
      });
      return out;
    }
    function paymentToText(list){
      if(!Array.isArray(list)) return "";
      return list.map(x=>String(x||"")).join("\n");
    }
    function parsePaymentText(txt){
      return String(txt||"").split("\n").map(x=>x.trim()).filter(Boolean);
    }

    // =============================
    // Settings: logo + super key icon upload
    // =============================
    let tmpLogoDataUrl = null;
    let tmpSuperKeyIconDataUrl = null;

    function fileToDataURLResized(file, maxSide=256){
      return new Promise((resolve, reject)=>{
        if(!file) return resolve("");
        const reader = new FileReader();
        reader.onload = ()=>{
          const img = new Image();
          img.onload = ()=>{
            const ratio = Math.min(1, maxSide / Math.max(img.width, img.height));
            const w = Math.max(1, Math.round(img.width * ratio));
            const h = Math.max(1, Math.round(img.height * ratio));

            const canvas = document.createElement("canvas");
            canvas.width = w;
            canvas.height = h;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, w, h);

            let out = "";
            try{ out = canvas.toDataURL("image/webp", 0.85); }catch(e){}
            if(!out || out.startsWith("data:,")){
              out = canvas.toDataURL("image/png");
            }
            resolve(out);
          };
          img.onerror = ()=> reject(new Error("bad image"));
          img.src = reader.result;
        };
        reader.onerror = ()=> reject(reader.error);
        reader.readAsDataURL(file);
      });
    }

    function renderSettingsPreviews(){
      const logoPrev = document.getElementById("sLogoPreview");
      if(logoPrev){
        const src = (tmpLogoDataUrl !== null) ? tmpLogoDataUrl : (settings.logoDataUrl || "");
        logoPrev.innerHTML = "";
        if(src){
          const img = document.createElement("img");
          img.src = src;
          img.alt = "logo";
          logoPrev.appendChild(img);
        }else{
          logoPrev.textContent = logoText();
        }
      }

      const skImg = document.getElementById("sSkPreview");
      const skTxt = document.getElementById("sSkPrevTxt");
      const skSrc = (tmpSuperKeyIconDataUrl !== null) ? tmpSuperKeyIconDataUrl : (settings.superKeyIconDataUrl || "");
      if(skImg && skTxt){
        if(skSrc){
          skImg.src = skSrc;
          skImg.style.display = "inline-block";
          skTxt.textContent = "موجودة";
        }else{
          skImg.removeAttribute("src");
          skImg.style.display = "none";
          skTxt.textContent = "لا يوجد";
        }
      }
    }

    function clearTempLogo(){
      tmpLogoDataUrl = "";
      renderSettingsPreviews();
    }
    function clearTempSK(){
      tmpSuperKeyIconDataUrl = "";
      renderSettingsPreviews();
    }

    function wireSettingsImageInputs(){
      const logoFile = document.getElementById("sLogoFile");
      if(logoFile){
        logoFile.onchange = async ()=>{
          const f = logoFile.files && logoFile.files[0];
          if(!f) return;
          try{
            tmpLogoDataUrl = await fileToDataURLResized(f, 256);
            renderSettingsPreviews();
            showToast("تم", "تم اختيار الشعار (سيُحفظ عند الضغط على حفظ)");
          }catch(e){
            alert("تعذر قراءة صورة الشعار");
          }
        };
      }

      const skFile = document.getElementById("sSkFile");
      if(skFile){
        skFile.onchange = async ()=>{
          const f = skFile.files && skFile.files[0];
          if(!f) return;
          try{
            tmpSuperKeyIconDataUrl = await fileToDataURLResized(f, 72);
            renderSettingsPreviews();
            showToast("تم", "تم اختيار علامة سوبر كي (ستظهر في الوصل)");
          }catch(e){
            alert("تعذر قراءة صورة علامة سوبر كي");
          }
        };
      }
    }

    function openSettings(){
      tmpLogoDataUrl = null;
      tmpSuperKeyIconDataUrl = null;

      const body = `
        <h3>الإعدادات</h3>
        <p class="subtxt">كل شيء هنا بسيط وواضح. تستطيع تغيير الخدمات وطرق الدفع والواجهة.</p>

        <div class="card" style="box-shadow:none;">
          <div style="font-weight:900; margin-bottom:8px;">بيانات المتجر</div>
          <label>اسم المتجر</label>
          <input id="sStore" value="${escapeHtml(settings.storeName)}"/>

          <div class="row2" style="margin-top:10px;">
            <div>
              <label>واتساب</label>
              <input id="sWA" value="${escapeHtml(settings.whatsappOwner)}"/>
            </div>
            <div>
              <label>انستقرام</label>
              <input id="sIG" value="${escapeHtml(settings.instagramUrl)}"/>
            </div>
          </div>
        </div>

        <div class="card" style="box-shadow:none;">
          <div style="font-weight:900; margin-bottom:8px;">الشعار</div>
          <div style="display:flex; gap:10px; align-items:center;">
            <div class="avatar" id="sLogoPreview" style="width:56px;height:56px;border-radius:18px;">${escapeHtml(logoText())}</div>
            <div class="muted">اختر صورة شعار. إن لم ترفع صورة سيظهر شعار بالحروف.</div>
          </div>

          <div style="margin-top:10px;">
            <input id="sLogoFile" type="file" accept="image/*"/>
          </div>

          <button class="btn soft full" style="margin-top:10px;" onclick="clearTempLogo()">حذف الشعار</button>
        </div>

        <div class="card" style="box-shadow:none;">
          <div style="font-weight:900; margin-bottom:8px;">علامة سوبر كي (بالوصل)</div>
          <div class="muted">تظهر صغيرة بجانب طريقة الدفع عندما تكون (سوبر كي).</div>

          <div style="display:flex; align-items:center; gap:10px; margin-top:10px;">
            <img id="sSkPreview" alt="SK" style="width:26px;height:26px;object-fit:contain;border:1px solid var(--line);border-radius:10px;padding:4px;background:var(--card);display:none;" />
            <span class="muted" id="sSkPrevTxt">لا يوجد</span>
          </div>

          <div style="margin-top:10px;">
            <input id="sSkFile" type="file" accept="image/*"/>
          </div>

          <button class="btn soft full" style="margin-top:10px;" onclick="clearTempSK()">حذف العلامة</button>
        </div>

        <div class="card" style="box-shadow:none;">
          <div style="font-weight:900; margin-bottom:8px;">المظهر والتنبيهات</div>
          <div class="row2">
            <div>
              <label>الثيم</label>
              <select id="sTheme">
                <option value="system">حسب الجهاز</option>
                <option value="light">فاتح</option>
                <option value="dark">داكن</option>
              </select>
            </div>
            <div>
              <label>اللون الأساسي</label>
              <input id="sAccent" type="color" value="${escapeHtml(settings.accent || DEFAULT_SETTINGS.accent)}"/>
            </div>
          </div>

          <div style="margin-top:10px;">
            <label>قريب الانتهاء خلال (يوم)</label>
            <input id="sRemind" type="number" min="0" max="14" value="${getRemindDays()}"/>
          </div>
        </div>

        <div class="card" style="box-shadow:none;">
          <div style="font-weight:900; margin-bottom:8px;">الخدمات والأسعار</div>
          <div class="muted">الصيغة: اسم|سعر1|سعر3|سعر12</div>
          <textarea id="sServices" style="margin-top:10px; min-height:120px;">${escapeHtml(servicesToText(settings.services))}</textarea>
        </div>

        <div class="card" style="box-shadow:none;">
          <div style="font-weight:900; margin-bottom:8px;">طرق الدفع (تظهر بالوصل)</div>
          <textarea id="sPay" style="min-height:110px;">${escapeHtml(paymentToText(settings.paymentMethods))}</textarea>
        </div>

        <div class="card" style="box-shadow:none;">
          <div style="font-weight:900; margin-bottom:8px;">قوالب واتساب</div>
          <label>تذكير</label>
          <textarea id="sTplR" style="min-height:110px;">${escapeHtml(settings.waTemplates?.reminder || DEFAULT_SETTINGS.waTemplates.reminder)}</textarea>
          <label style="margin-top:10px;">حالة</label>
          <textarea id="sTplS" style="min-height:110px;">${escapeHtml(settings.waTemplates?.status || DEFAULT_SETTINGS.waTemplates.status)}</textarea>
          <label style="margin-top:10px;">شكر الدفع</label>
          <textarea id="sTplT" style="min-height:110px;">${escapeHtml(settings.waTemplates?.thanks || DEFAULT_SETTINGS.waTemplates.thanks)}</textarea>
          <div class="muted" style="margin-top:8px;">
            المتغيرات: {store} {name} {service} {end} {daysLeftHuman} {paidStatus}
          </div>
        </div>

        <div class="grid cols-2" style="margin-top:12px;">
          <button class="btn primary full" onclick="saveSettings()">حفظ</button>
          <button class="btn soft full" onclick="hideModal()">إغلاق</button>
        </div>
      `;
      showModal(body);
      setTimeout(()=>{
        document.getElementById("sTheme").value = settings.theme || "system";
        wireSettingsImageInputs();
        renderSettingsPreviews();
      }, 0);
    }

    function saveSettings(){
      settings.storeName = (document.getElementById("sStore").value||"").trim() || DEFAULT_SETTINGS.storeName;
      settings.whatsappOwner = (document.getElementById("sWA").value||"").trim() || DEFAULT_SETTINGS.whatsappOwner;
      settings.instagramUrl = (document.getElementById("sIG").value||"").trim() || DEFAULT_SETTINGS.instagramUrl;

      settings.theme = document.getElementById("sTheme").value || "system";
      settings.accent = document.getElementById("sAccent").value || DEFAULT_SETTINGS.accent;
      settings.remindDaysBefore = Number(document.getElementById("sRemind").value||1);

      const parsedServices = parseServicesText(document.getElementById("sServices").value || "");
      if(parsedServices.length) settings.services = parsedServices;

      const parsedPay = parsePaymentText(document.getElementById("sPay").value || "");
      if(parsedPay.length) settings.paymentMethods = parsedPay;

      settings.waTemplates = {
        reminder: document.getElementById("sTplR").value || DEFAULT_SETTINGS.waTemplates.reminder,
        status:   document.getElementById("sTplS").value || DEFAULT_SETTINGS.waTemplates.status,
        thanks:   document.getElementById("sTplT").value || DEFAULT_SETTINGS.waTemplates.thanks
      };

      if(tmpLogoDataUrl !== null) settings.logoDataUrl = tmpLogoDataUrl;
      if(tmpSuperKeyIconDataUrl !== null) settings.superKeyIconDataUrl = tmpSuperKeyIconDataUrl;

      tmpLogoDataUrl = null;
      tmpSuperKeyIconDataUrl = null;

      save(K_SETTINGS, settings);

      applyTheme();
      applyBrand();
      renderServicesSelect();

      hideModal();
      showToast("تم", "تم حفظ الإعدادات");
      renderAll();
    }

    // =============================
    // Receipt: fill + export image
    // =============================
    function fillReceiptForCustomer(c){
      const box = document.getElementById("receiptBox");
      if(!box) return;

      box.classList.toggle("paid", !!c.paid);
      box.classList.toggle("unpaid", !c.paid);

      const store = settings.storeName || DEFAULT_SETTINGS.storeName;
      document.getElementById("rStore").textContent = store;

      const dt = new Date();
      const time = dt.toLocaleTimeString("ar-IQ", { hour:"2-digit", minute:"2-digit" });
      document.getElementById("rMeta").textContent = `وصل اشتراك • ${ymd()} • ${time}`;

      const rLogo = document.getElementById("rLogo");
      if(rLogo){
        rLogo.innerHTML = "";
        if(settings.logoDataUrl){
          const img = document.createElement("img");
          img.src = settings.logoDataUrl;
          img.alt = "logo";
          rLogo.appendChild(img);
        }else{
          rLogo.textContent = logoText();
        }
      }

      const st = statusOf(c);
      const badge = document.getElementById("rStatusBadge");
      if(badge){
        badge.textContent = c.paid ? "مدفوع ✅" : "غير مدفوع";
      }

      const dataEl = document.getElementById("rData");
      if(dataEl){
        dataEl.innerHTML = `
          <div class="r-kv"><span>الزبون</span><b>${escapeHtml(c.name)}</b></div>
          <div class="r-kv"><span>الخدمة</span><b>${escapeHtml(c.service)}</b></div>
          <div class="r-kv"><span>بدء</span><b>${escapeHtml(c.start)}</b></div>
          <div class="r-kv"><span>انتهاء</span><b>${escapeHtml(c.end)}</b></div>
          <div class="r-kv"><span>المتبقي</span><b>${escapeHtml(daysLeftHuman(st.dl))}</b></div>
          <div class="r-kv total"><span>المبلغ</span><b>${escapeHtml(money(c.price))}</b></div>
        `;
      }

      const payTitle = document.getElementById("rPayTitle");
      const payList = document.getElementById("rPayList");
      if(payTitle) payTitle.textContent = c.paid ? "طريقة الدفع" : "طرق الدفع";

      if(payList){
        if(c.paid){
          const m = c.paidMethod || "—";
          const icon = isSuperKeyMethod(m) ? superKeyIconHtml() : "";
          const note = c.paidNote ? `<div class="pm-note">${escapeHtml(c.paidNote)}</div>` : "";
          payList.innerHTML = `<li><span class="pm">${escapeHtml(m)}${icon}</span>${note}</li>`;
        }else{
          const methods = Array.isArray(settings.paymentMethods) ? settings.paymentMethods : DEFAULT_SETTINGS.paymentMethods;
          payList.innerHTML = methods.map(m=>{
            const icon = isSuperKeyMethod(m) ? superKeyIconHtml() : "";
            return `<li><span class="pm">${escapeHtml(m)}${icon}</span></li>`;
          }).join("");
        }
      }

      const foot = document.getElementById("rFoot");
      if(foot){
        foot.textContent =
`شكراً لتعاملكم معنا 💙
للاستفسار: واتساب ${cleanPhone(settings.whatsappOwner)}
انستقرام: ${settings.instagramUrl}`;
      }

      const qrEl = document.getElementById("rQR");
      if(qrEl){
        qrEl.innerHTML = "";
        const qrData =
`Store: ${store}
Customer: ${c.name}
Service: ${c.service}
Start: ${c.start}
End: ${c.end}
Amount: ${c.price}
Paid: ${c.paid ? "yes" : "no"}
Method: ${c.paidMethod || ""}
Issued: ${ymd()} ${time}`;
        if(window.QRCode){
          new QRCode(qrEl, { text: qrData, width: 120, height: 120, correctLevel: QRCode.CorrectLevel.M });
        }else{
          // QR library not loaded (offline) — keep the receipt usable.
          qrEl.innerHTML = `<div class="muted" style="text-align:center;">QR غير متوفر بدون انترنت</div>`;
        }
      }
    }

    
function openReceipt(id){
      const c = customers.find(x=>x.id===id);
      if(!c) return;

      // Always show a preview first (works even if html2canvas is missing)
      fillReceiptForCustomer(c);

      // Clone the hidden receipt to display inside the modal
      const clone = document.getElementById("receiptBox").cloneNode(true);
      clone.id = "receiptPreview";
      clone.style.width = "100%";
      clone.style.maxWidth = "420px";
      clone.style.margin = "0 auto";
      clone.style.boxShadow = "var(--shadow2)";

      window.__lastReceiptDataUrl = null;

      const body = `
        <h3>وصل ${escapeHtml(c.name)}</h3>
        <p class="subtxt">
          إذا ما اشتغل (تحويل لصورة)، هذا غالباً بسبب عدم توفر الانترنت لتحميل مكتبة html2canvas،
          أو لأن WebView يمنع التحميل. لكن الوصل سيظهر هنا دائماً.
        </p>

        <div style="text-align:center;" id="receiptPreviewContainer"></div>

        <div class="grid cols-2" style="margin-top:12px;">
          <button class="btn primary full" onclick="exportReceiptPng('${id}')">تحويل لصورة</button>
          <button class="btn soft full" onclick="hideModal()">إغلاق</button>
        </div>

        <div id="receiptImgBox" style="display:none; text-align:center; margin-top:12px;">
          <img id="receiptImg" alt="receipt" style="width:100%;max-width:420px;border-radius:18px;border:1px solid var(--line);" />
        </div>

        <div class="grid cols-2" id="receiptImgActions" style="display:none; margin-top:12px;">
          <button class="btn success full" onclick="downloadReceiptImage()">تحميل / حفظ</button>
          <button class="btn soft full" onclick="openReceiptImageExternal()">فتح الصورة</button>
        </div>

        <div class="muted" style="margin-top:10px;">
          ملاحظة: في Kodular، إذا التحميل ما اشتغل داخل التطبيق، زر (فتح الصورة) يفتحها خارجياً وتقدر تحفظها من هناك.
        </div>
      `;
      showModal(body);

      setTimeout(()=>{
        const cont = document.getElementById("receiptPreviewContainer");
        if(cont){
          cont.innerHTML = "";
          cont.appendChild(clone);
        }
      }, 0);
    }

    async function exportReceiptPng(id){
      const c = customers.find(x=>x.id===id);
      if(!c) return;

      fillReceiptForCustomer(c);

      if(!window.html2canvas){
        showToast("تنبيه", "مكتبة التحويل (html2canvas) غير محمّلة. تأكد من الانترنت أو حمّل الملف مع المكتبات محلياً.", null, 4500);
        return;
      }

      try{
        // Allow QR to render
        await new Promise(r=>setTimeout(r, 120));

        const canvas = await html2canvas(document.getElementById("receiptBox"), {
          scale: 2,
          backgroundColor: "#ffffff",
          useCORS: true,
          allowTaint: true
        });

        const imgUrl = canvas.toDataURL("image/png");
        window.__lastReceiptDataUrl = imgUrl;

        const imgBox = document.getElementById("receiptImgBox");
        const imgEl  = document.getElementById("receiptImg");
        const acts   = document.getElementById("receiptImgActions");

        if(imgEl) imgEl.src = imgUrl;
        if(imgBox) imgBox.style.display = "block";
        if(acts) acts.style.display = "grid";

        showToast("تم", "تم تجهيز صورة الوصل", null, 2200);
      }catch(e){
        console.error(e);
        showToast("خطأ", "تعذر تحويل الوصل لصورة داخل WebView. جرّب زر (فتح الصورة) أو افتح الملف بمتصفح Chrome.", null, 4500);
      }
    }

    function downloadReceiptImage(){
      const dataUrl = window.__lastReceiptDataUrl;
      if(!dataUrl){
        showToast("تنبيه", "حوّل الوصل لصورة أولاً (زر تحويل لصورة).", null, 3500);
        return;
      }

      // In Kodular/AppInventor WebViewer: download attribute may not work.
      const hasBridge = (window.Kodular && window.Kodular.setWebViewString) || (window.AppInventor && window.AppInventor.setWebViewString);

      if(hasBridge){
        // Try to open externally (best chance to save on Android)
        openExternal(dataUrl);

        // Also send base64 to the host (optional for you to handle in Kodular)
        try{
          const payload = "RECEIPT_PNG:" + dataUrl;
          if(window.Kodular && window.Kodular.setWebViewString) window.Kodular.setWebViewString(payload);
          else if(window.AppInventor && window.AppInventor.setWebViewString) window.AppInventor.setWebViewString(payload);
        }catch(e){}

        showToast("تم", "تم فتح الصورة خارجياً. إذا تريد حفظ مباشر داخل التطبيق، استقبل (RECEIPT_PNG) من WebViewString.", null, 4500);
        return;
      }

      // Browser fallback
      downloadDataUrl(dataUrl, `receipt-${ymd()}.png`);
    }

    function openReceiptImageExternal(){
      const dataUrl = window.__lastReceiptDataUrl;
      if(!dataUrl){
        showToast("تنبيه", "حوّل الوصل لصورة أولاً (زر تحويل لصورة).", null, 3500);
        return;
      }
      openExternal(dataUrl);
    }

    function downloadDataUrl(dataUrl, filename){
      try{
        const a = document.createElement("a");
        a.href = dataUrl;
        a.download = filename || `receipt-${ymd()}.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();
      }catch(e){
        // fallback: open the image
        openExternal(dataUrl);
      }
    }

    // =============================
    // Subscribers: render + actions modal + edit
    // =============================
    function badgeHtml(text, cls){
      return `<span class="badge ${cls||""}">${escapeHtml(text)}</span>`;
    }

    function openCustomerActions(id){
      const c = customers.find(x=>x.id===id);
      if(!c) return;
      const st = statusOf(c);

      const body = `
        <h3>${escapeHtml(c.name)}</h3>
        <p class="subtxt">اختر العملية المطلوبة.</p>

        <div class="grid cols-2">
          <button class="btn soft full" onclick="sendWA('${id}','status')">واتساب (حالة)</button>
          <button class="btn soft full" onclick="sendWA('${id}','reminder')">واتساب (تذكير)</button>
        </div>

        <div class="grid cols-2" style="margin-top:10px;">
          <button class="btn soft full" onclick="sendWA('${id}','thanks')">شكر الدفع</button>
          <button class="btn soft full" onclick="openReceipt('${id}')">إظهار الوصل</button>
        </div>

        <div class="grid cols-2" style="margin-top:10px;">
          <button class="btn primary full" onclick="openEditCustomer('${id}')">تعديل</button>
          <button class="btn soft full" onclick="openConfirmRenew('${id}')">تجديد</button>
        </div>

        <div class="grid cols-2" style="margin-top:10px;">
          <button class="btn danger full" onclick="deleteCustomer('${id}')">حذف</button>
          <button class="btn soft full" onclick="hideModal()">إغلاق</button>
        </div>
      `;
      showModal(body);
    }

    function openConfirmRenew(id){
      const c = customers.find(x=>x.id===id);
      if(!c) return;
      const body = `
        <h3>تجديد الاشتراك</h3>
        <p class="subtxt">سيتم التجديد من اليوم بنفس مدة الاشتراك (${Number(c.durationMonths||1)} شهر).</p>
        <div class="grid cols-2" style="margin-top:12px;">
          <button class="btn primary full" onclick="confirmRenew('${id}')">تأكيد التجديد</button>
          <button class="btn soft full" onclick="hideModal()">إلغاء</button>
        </div>
      `;
      showModal(body);
    }

    function openEditCustomer(id){
      const c = customers.find(x=>x.id===id);
      if(!c) return;
      normalizeServices();
      const svcOpts = settings.services.map(s=>`<option value="${escapeHtml(s.name)}">${escapeHtml(s.name)}</option>`).join("");

      const body = `
        <h3>تعديل اشتراك</h3>
        <p class="subtxt">عدّل البيانات ثم اضغط حفظ.</p>

        <div class="row2">
          <div>
            <label>الخدمة</label>
            <select id="eService">${svcOpts}</select>
          </div>
          <div>
            <label>المدة</label>
            <select id="eDuration" onchange="calcEditEnd()">
              <option value="1">شهر</option>
              <option value="3">3 أشهر</option>
              <option value="12">سنة</option>
            </select>
          </div>
        </div>

        <div style="margin-top:10px;">
          <label>اسم الزبون</label>
          <input id="eName" />
        </div>

        <div style="margin-top:10px;">
          <label>رقم الواتساب</label>
          <input id="ePhone" />
        </div>

        <div class="row2" style="margin-top:10px;">
          <div>
            <label>المبلغ (دينار)</label>
            <input id="ePrice" type="number" />
          </div>
          <div>
            <label>VIP</label>
            <select id="eVip">
              <option value="no">لا</option>
              <option value="yes">نعم</option>
            </select>
          </div>
        </div>

        <div class="row2" style="margin-top:10px;">
          <div>
            <label>تاريخ البدء</label>
            <input id="eStart" type="date" onchange="calcEditEnd()" />
          </div>
          <div>
            <label>تاريخ النهاية</label>
            <input id="eEnd" type="date" />
          </div>
        </div>

        <div style="margin-top:10px;">
          <label>ملاحظة</label>
          <textarea id="eNote"></textarea>
        </div>

        <div class="grid cols-2" style="margin-top:12px;">
          <button class="btn primary full" onclick="saveEditCustomer('${id}')">حفظ</button>
          <button class="btn soft full" onclick="hideModal()">إغلاق</button>
        </div>
      `;
      showModal(body);

      setTimeout(()=>{
        document.getElementById("eService").value = c.service;
        document.getElementById("eDuration").value = String(Number(c.durationMonths||1));
        document.getElementById("eName").value = c.name || "";
        document.getElementById("ePhone").value = c.phone || "";
        document.getElementById("ePrice").value = Number(c.price||0);
        document.getElementById("eVip").value = c.vip ? "yes" : "no";
        document.getElementById("eStart").value = c.start || ymd();
        document.getElementById("eEnd").value = c.end || ymd();
        document.getElementById("eNote").value = c.note || "";
      }, 0);
    }

    function calcEditEnd(){
      const start = parseYMD(document.getElementById("eStart").value);
      const dm = Number(document.getElementById("eDuration").value||1);
      if(!start) return;
      const end = new Date(start.getFullYear(), start.getMonth()+dm, start.getDate());
      document.getElementById("eEnd").value = ymd(end);
    }

    function saveEditCustomer(id){
      const i = customers.findIndex(x=>x.id===id);
      if(i<0) return;

      const c = customers[i];
      c.service = document.getElementById("eService").value || c.service;
      c.durationMonths = Number(document.getElementById("eDuration").value||c.durationMonths||1);
      c.name = (document.getElementById("eName").value||"").trim() || c.name;
      c.phone = (document.getElementById("ePhone").value||"").trim() || c.phone;
      c.price = Number(document.getElementById("ePrice").value||c.price||0);
      c.vip = (document.getElementById("eVip").value === "yes");
      c.start = document.getElementById("eStart").value || c.start;
      c.end = document.getElementById("eEnd").value || c.end;
      c.note = (document.getElementById("eNote").value||"").trim();

      save(K_CUSTOMERS, customers);
      addActivity("edit", `تم تعديل اشتراك: ${c.name}`, null);

      hideModal();
      showToast("تم", "تم حفظ التعديل");
      renderHome(); renderSubs();
    }

    function renderSubs(){
      const q = (document.getElementById("qSub").value || "").trim().toLowerCase();
      let list = customers.slice();

      list = list.filter(c=>{
        const st = statusOf(c);
        if(filter==="active") return st.dl !== null && st.dl >= 0;
        if(filter==="soon") return st.dl !== null && st.dl >= 0 && st.dl <= getRemindDays();
        if(filter==="expired") return st.dl !== null && st.dl < 0;
        if(filter==="unpaid") return !c.paid;
        if(filter==="paid") return !!c.paid;
        if(filter==="vip") return !!c.vip;
        return true;
      });

      if(q){
        list = list.filter(c=>{
          const hay = `${c.name||""} ${c.phone||""} ${c.service||""} ${c.note||""}`.toLowerCase();
          return hay.includes(q);
        });
      }

      document.getElementById("uiCountLine").textContent = `${list.length} / ${customers.length}`;

      const box = document.getElementById("uiSubs");
      if(list.length===0){
        box.innerHTML = `<div class="card"><div class="muted">لا توجد نتائج.</div></div>`;
        return;
      }

      const html = list.map(c=>{
        const st = statusOf(c);
        const cls = `${st.expired ? "expired": (st.soon ? "soon":"")} ${c.vip ? "vip":""}`.trim();

        let badges = "";
        if(st.expired) badges += badgeHtml("منتهي", "bad");
        else if(st.soon) badges += badgeHtml(`قريب (${daysLeftHuman(st.dl)})`, "warn");
        else badges += badgeHtml("فعّال", "good");

        badges += c.paid ? badgeHtml("مدفوع", "good") : badgeHtml("غير مدفوع", "bad");
        if(c.vip) badges += badgeHtml("VIP", "purple");
        if(c.remindedEnd && c.remindedEnd === c.end) badges += badgeHtml("تم التذكير", "");

        const pm = c.paid ? (c.paidMethod || "—") : "—";

        return `
          <div class="sub ${cls}">
            <div class="sub-top">
              <div style="min-width:0;">
                <div class="sub-name">${escapeHtml(c.name)}</div>
                <div style="margin-top:8px;">${badges}</div>
              </div>
            </div>

            <div class="sub-meta">
              <div>الخدمة: <b>${escapeHtml(c.service)}</b></div>
              <div>الانتهاء: <b>${escapeHtml(c.end)}</b> • ${escapeHtml(daysLeftHuman(st.dl))}</div>
              <div>الرقم: <b dir="ltr">${escapeHtml(cleanPhone(c.phone))}</b></div>
              <div>المبلغ: <b>${escapeHtml(money(c.price))}</b>${c.paid ? ` • الدفع: <b>${escapeHtml(pm)}</b>` : ""}</div>
              ${c.note ? `<div>ملاحظة: <b>${escapeHtml(c.note)}</b></div>` : ""}
            </div>

            <div class="sub-actions">
              <button class="a-btn primary" onclick="sendWA('${c.id}','auto')" title="واتساب">
                <svg><use href="#i-wa"></use></svg>
              </button>
              <button class="a-btn primary" onclick="openReceipt('${c.id}')" title="وصل">
                <svg><use href="#i-receipt"></use></svg>
              </button>
              <button class="a-btn success" onclick="togglePaid('${c.id}')" title="${c.paid ? "إلغاء الدفع" : "تسجيل دفع"}">
                <svg><use href="#i-check"></use></svg>
              </button>
              <button class="a-btn" onclick="openCustomerActions('${c.id}')" title="المزيد">
                <svg><use href="#i-more"></use></svg>
              </button>
            </div>
          </div>
        `;
      }).join("");

      box.innerHTML = html;
    }

    // =============================
    // Home render (stats, soon list, activity)
    // =============================
    function renderHome(){
      const today = new Date();
      const todayLine = today.toLocaleDateString("ar-IQ", { weekday:"long", year:"numeric", month:"2-digit", day:"2-digit" });
      document.getElementById("uiTodayLine").textContent = todayLine;

      document.getElementById("stTodayIncome").textContent = money(sumIncomeToday());
      document.getElementById("stTotalIncome").textContent = money(sumIncomeAll());
      document.getElementById("stActive").textContent = String(countActive());

      const d = getRemindDays();
      document.getElementById("lblExpSoon").textContent = `قريب الانتهاء (≤ ${d} يوم)`;
      document.getElementById("stExpSoon").textContent = String(countSoon());

      // soon list
      const soon = customers
        .map(c=>({c, st: statusOf(c)}))
        .filter(x=> x.st.dl !== null && x.st.dl >= 0 && x.st.dl <= d)
        .sort((a,b)=> (a.st.dl - b.st.dl))
        .slice(0, 6);

      const soonBox = document.getElementById("uiSoonList");
      if(soon.length===0){
        soonBox.innerHTML = `<div class="muted">لا يوجد اشتراكات قريبة الانتهاء.</div>`;
      }else{
        soonBox.innerHTML = soon.map(({c, st})=>{
          return `
            <div class="sub soon" style="margin-bottom:10px;">
              <div class="sub-top">
                <div style="min-width:0;">
                  <div class="sub-name">${escapeHtml(c.name)}</div>
                  <div class="sub-meta">
                    <div>الخدمة: <b>${escapeHtml(c.service)}</b></div>
                    <div>الانتهاء: <b>${escapeHtml(c.end)}</b> • ${escapeHtml(daysLeftHuman(st.dl))}</div>
                  </div>
                </div>
                <div>
                  ${c.paid ? badgeHtml("مدفوع","good") : badgeHtml("غير مدفوع","bad")}
                </div>
              </div>

              <div class="sub-actions">
                <button class="a-btn primary" onclick="sendWA('${c.id}','reminder')" title="تذكير واتساب">
                  <svg><use href="#i-wa"></use></svg>
                </button>
                <button class="a-btn primary" onclick="openReceipt('${c.id}')" title="وصل">
                  <svg><use href="#i-receipt"></use></svg>
                </button>
                <button class="a-btn" onclick="openCustomerActions('${c.id}')" title="المزيد">
                  <svg><use href="#i-more"></use></svg>
                </button>
              </div>
            </div>
          `;
        }).join("");
      }

      // activity
      const act = activity.slice(0, 12);
      const aBox = document.getElementById("uiActivity");
      if(act.length===0){
        aBox.innerHTML = `<div class="muted">لا يوجد نشاط بعد.</div>`;
      }else{
        aBox.innerHTML = act.map(x=>{
          const amt = (x.amount !== null && x.amount !== undefined) ? ` • <b>${escapeHtml(money(x.amount))}</b>` : "";
          return `
            <div class="sub" style="padding:12px; margin-bottom:10px;">
              <div style="font-weight:900;">${escapeHtml(x.text || "—")}</div>
              <div class="muted" style="margin-top:6px;">${escapeHtml(timeHM(x.ts))}${amt}</div>
            </div>
          `;
        }).join("");
      }
    }

    // =============================
    // Reminders modal
    // =============================
    function openReminders(){
      const d = getRemindDays();
      const soon = customers
        .map(c=>({c, st: statusOf(c)}))
        .filter(x=> x.st.dl !== null && x.st.dl >= 0 && x.st.dl <= d)
        .sort((a,b)=> a.st.dl - b.st.dl);

      const expired = customers
        .map(c=>({c, st: statusOf(c)}))
        .filter(x=> x.st.dl !== null && x.st.dl < 0)
        .sort((a,b)=> a.st.dl - b.st.dl);

      const listHtml = (arr, kind)=> {
        if(arr.length===0) return `<div class="muted">لا يوجد.</div>`;
        return arr.map(({c, st})=>{
          const line = `${escapeHtml(c.service)} • ${escapeHtml(c.end)} • ${escapeHtml(daysLeftHuman(st.dl))}`;
          const btn = (kind==="soon")
            ? `<button class="btn primary full" onclick="sendWA('${c.id}','reminder')">إرسال تذكير</button>`
            : `<button class="btn soft full" onclick="sendWA('${c.id}','status')">إرسال حالة</button>`;
          return `
            <div class="card" style="box-shadow:none;">
              <div style="font-weight:900;">${escapeHtml(c.name)}</div>
              <div class="muted" style="margin-top:6px;">${line}</div>
              <div class="grid cols-2" style="margin-top:10px;">
                ${btn}
                <button class="btn soft full" onclick="openReceipt('${c.id}')">وصل</button>
              </div>
            </div>
          `;
        }).join("");
      };

      const body = `
        <h3>المنتهي قريباً / المنتهي</h3>
        <p class="subtxt">قريب الانتهاء خلال ≤ ${d} يوم. تستطيع إرسال تذكير أو عرض الوصل.</p>

        <div style="font-weight:900; margin:10px 0 8px;">قريب الانتهاء</div>
        ${listHtml(soon, "soon")}

        <div style="font-weight:900; margin:14px 0 8px;">منتهي</div>
        ${listHtml(expired, "expired")}

        <button class="btn soft full" style="margin-top:10px;" onclick="hideModal()">إغلاق</button>
      `;
      showModal(body);
    }

    // =============================
    // Render all
    // =============================
    function renderAll(){
      renderHome();
      renderSubs();
      renderAddInit();
    }

    // =============================
    // Init
    // =============================
    (function init(){
      applyTheme();
      applyBrand();
      renderAll();
      // Ensure add page defaults are ready (even if not opened yet)
      const startEl = document.getElementById("fStart");
      if(startEl) startEl.value = ymd();
      calcEnd();
    })();
  </script>
</body>
</html>
